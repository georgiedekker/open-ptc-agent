name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      - name: Run ruff on ptc-agent
        run: uv run ruff check libs/ptc-agent/ptc_agent/ libs/ptc-agent/tests/

      - name: Run ruff on ptc-cli
        run: uv run ruff check libs/ptc-cli/ptc_cli/ libs/ptc-cli/tests/

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      - name: Run mypy on ptc-agent
        working-directory: libs/ptc-agent
        run: uv run mypy ptc_agent/

      - name: Run mypy on ptc-cli
        working-directory: libs/ptc-cli
        run: uv run mypy ptc_cli/

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      - name: Run ptc-agent unit tests
        run: uv run pytest libs/ptc-agent/tests/unit_tests/ -v

      - name: Run ptc-cli unit tests
        run: uv run pytest libs/ptc-cli/tests/unit_tests/ -v

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, type-check, unit-tests]
    environment: integration
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      - name: Run ptc-agent integration tests
        env:
          DAYTONA_API_KEY: ${{ secrets.DAYTONA_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: uv run pytest libs/ptc-agent/tests/integration_tests/ -v

      - name: Run ptc-cli integration tests
        env:
          DAYTONA_API_KEY: ${{ secrets.DAYTONA_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: uv run pytest libs/ptc-cli/tests/integration_tests/ -v
